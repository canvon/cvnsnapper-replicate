#!/bin/bash

warn() {
	echo "${0##*/}: $*" >&2
}

die() {
	warn "Fatal: $*"
	exit 1
}


INFIX=

USAGE="Usage: $0 [--infix=INFIX] SUBVOL [...]"

[ "$#" -ge 1 ] || die "$USAGE"

while [ "$#" -ge 1 ] && [ "${1:0:1}" = "-" ]
do
	case "$1" in
	--help|--usage)
		shift
		echo "$USAGE"
		exit 0
		;;
	--infix=*)
		INFIX=${1#--infix=}
		shift
		echo "Using infix \"$INFIX\""
		;;
	-*)
		die "Unrecognized option \"$1\""
		;;
	esac
done


for SUBVOL
do
	[ -d "$SUBVOL" ] || die "Not a directory: $SUBVOL"

	[ "$(stat --format="%i" "$SUBVOL")" -eq 256 ] || die "Not a btrfs subvolume: $SUBVOL"


	export SUBVOL_STAT_LOG="${SUBVOL}${INFIX}.stat.log"
	export SUBVOL_CHECKSUMS_FILE="${SUBVOL}${INFIX}.sha256"

	[ -e "$SUBVOL_STAT_LOG" ] && die "Stat log file for btrfs subvolume \"$SUBVOL\" already exists: $SUBVOL_STAT_LOG"
	[ -e "$SUBVOL_CHECKSUMS_FILE" ] && die "Checksums file for btrfs subvolume \"$SUBVOL\" already exists: $SUBVOL_CHECKSUMS_FILE"

	exec {SUBVOL_STAT_LOG_FD}>>"$SUBVOL_STAT_LOG" || die "Couldn't open stat log file for btrfs subvolume \"$SUBVOL\": $SUBVOL_STAT_LOG"
	export SUBVOL_STAT_LOG_FD

	exec {SUBVOL_CHECKSUMS_FILE_FD}>>"$SUBVOL_CHECKSUMS_FILE" || die "Couldn't open checksums file for btrfs subvolume \"$SUBVOL\": $SUBVOL_CHECKSUMS_FILE"
	export SUBVOL_CHECKSUMS_FILE_FD 


	echo "Processing btrfs subvolume $SUBVOL ..."

	( cd "$SUBVOL" && find \
		! -path . -inum 256 -printf "Pruning child subvolume %p\n" -prune , \
		-type f -exec bash -c "sha256sum --binary -- \"\$@\" >&\"\$SUBVOL_CHECKSUMS_FILE_FD\"" checksums "{}" + , \
		-exec bash -c "stat -- \"\$@\" >&\"\$SUBVOL_STAT_LOG_FD\"" stat-log "{}" +
	) || die "Subshell with cd and find exited unsuccessfully (with exit code $?)"


	exec {SUBVOL_CHECKSUMS_FILE_FD}>&- || die "Couldn't close checksums file for btrfs subvolume \"$SUBVOL\": $SUBVOL_CHECKSUMS_FILE"
	unset SUBVOL_CHECKSUMS_FILE_FD SUBVOL_CHECKSUMS_FILE

	exec {SUBVOL_STAT_LOG_FD}>&- || die "Couldn't close stat log file for btrfs subvolume \"$SUBVOL\": $SUBVOL_STAT_LOG"
	unset SUBVOL_STAT_LOG_FD SUBVOL_STAT_LOG
done

exit 0

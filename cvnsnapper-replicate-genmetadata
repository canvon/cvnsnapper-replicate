#!/bin/bash

warn() {
	echo "${0##*/}: $*" >&2
}

die() {
	warn "Fatal: $*"
	exit 1
}


USAGE="Usage: $0 SUBVOL [...]"

[ "$#" -ge 1 ] || die "$USAGE"

case "$1" in
--help|--usage)
	shift
	echo "$USAGE"
	exit 0
	;;
-*)
	die "Unrecognized option \"$1\""
	;;
esac


for SUBVOL
do
	[ -d "$SUBVOL" ] || die "Not a directory: $SUBVOL"

	[ "$(stat --format="%i" "$SUBVOL")" -eq 256 ] || die "Not a btrfs subvolume: $SUBVOL"


	export SUBVOL_STAT_LOG="${SUBVOL}.stat.log"

	[ -e "$SUBVOL_STAT_LOG" ] && die "Stat log file for btrfs subvolume \"$SUBVOL\" already exists: $SUBVOL_STAT_LOG"

	exec {SUBVOL_STAT_LOG_FD}>>"$SUBVOL_STAT_LOG" || die "Couldn't open stat log file for btrfs subvolume \"$SUBVOL\": $SUBVOL_STAT_LOG"
	export SUBVOL_STAT_LOG_FD


	echo "Processing btrfs subvolume $SUBVOL ..."

	( cd "$SUBVOL" && find \
		! -path . -inum 256 -printf "Pruning child subvolume %p\n" -prune , \
		-exec bash -c "stat -- \"\$@\" >&\"\$SUBVOL_STAT_LOG_FD\"" stat-log "{}" +
	)


	exec {SUBVOL_STAT_LOG_FD}>&- || die "Couldn't close stat log file for btrfs subvolume \"$SUBVOL\": $SUBVOL_STAT_LOG"
	unset \
		SUBVOL_STAT_LOG_FD \
		SUBVOL_STAT_LOG
done
